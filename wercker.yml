box: hashexpression/wercker
no-response-timeout: 10

build:
  # Steps make up the actions in your pipeline
  # Read more about steps on our dev center:
  # https://devcenter.wercker.com/development/steps/
  steps:
    - script:
        name: restore cache
        code: |
          if [ -e "$WERCKER_CACHE_DIR/.stack-work" ]; then
            cp -r $WERCKER_CACHE_DIR/.stack-work .stack-work
          fi
    - script:
        name: build & test
        code: |
          stack build --test --ghc-options -O2 --copy-bins --local-bin-path bins
    - script:
        name: store cache
        code: |
          cp -r .stack-work $WERCKER_CACHE_DIR/.stack-work


create-release:
  box: ubuntu
  steps:
    - install-packages:
        packages: curl file
    - script:
        name: Get release version
        code: |
          export RELEASE_VERSION=$(cat VERSION)
    - script:
        name: Create symphony archive
        code: |
          tar czf symphony-$RELEASE_VERSION.tar.gz --directory=bins symphony
    - wercker/github-create-release@2.1.1:
        token: $GITHUB_TOKEN
        tag: $RELEASE_VERSION
        title: $RELEASE_VERSION
    - wercker/github-upload-asset@2.1.1:
        token: $GITHUB_TOKEN
        file: symphony-$RELEASE_VERSION.tar.gz


